// routes/roomTypes.js - ROTAS PARA TIPOS DE QUARTO
const express = require('express');
const router = express.Router();
const RoomType = require('../models/RoomType');
const { authenticate } = require('../middleware/auth');

// âœ… GET /api/room-types - Listar todos os tipos
router.get('/', authenticate, async (req, res) => {
  try {
    console.log('ğŸ“¥ GET /api/room-types - Listando tipos de quarto...');
    
    const roomTypes = await RoomType.findActive();
    
    console.log(`âœ… ${roomTypes.length} tipos encontrados`);
    
    res.json({
      success: true,
      data: roomTypes,
      message: `${roomTypes.length} tipos de quarto encontrados`
    });
  } catch (error) {
    console.error('âŒ Erro ao buscar tipos de quarto:', error);
    res.status(500).json({
      success: false,
      message: 'Erro interno do servidor',
      error: error.message
    });
  }
});

// âœ… GET /api/room-types/:id - Buscar tipo especÃ­fico
router.get('/:id', authenticate, async (req, res) => {
  try {
    console.log(`ğŸ“¥ GET /api/room-types/${req.params.id}`);
    
    const roomType = await RoomType.findOne({ 
      id: req.params.id, 
      active: true 
    });
    
    if (!roomType) {
      return res.status(404).json({
        success: false,
        message: 'Tipo de quarto nÃ£o encontrado'
      });
    }
    
    res.json({
      success: true,
      data: roomType,
      message: 'Tipo encontrado'
    });
  } catch (error) {
    console.error('âŒ Erro ao buscar tipo:', error);
    res.status(500).json({
      success: false,
      message: 'Erro interno do servidor',
      error: error.message
    });
  }
});

// âœ… POST /api/room-types - Criar novo tipo
router.post('/', authenticate, async (req, res) => {
  try {
    console.log('ğŸ“¤ POST /api/room-types - Criando novo tipo...');
    console.log('ğŸ“¦ Dados recebidos:', req.body);
    
    const { nome, periodosConfig, precosBase, amenidadesPadrao, descricao } = req.body;

    if (!nome || !nome.trim()) {
      return res.status(400).json({
        success: false,
        message: 'Nome do tipo Ã© obrigatÃ³rio'
      });
    }

    const id = nome.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

    // Verificar se jÃ¡ existe
    const existingType = await RoomType.findOne({ id });
    if (existingType) {
      return res.status(400).json({
        success: false,
        message: 'Tipo de quarto jÃ¡ existe'
      });
    }

    // Buscar o maior order atual
    const lastType = await RoomType.findOne().sort({ order: -1 });
    const newOrder = lastType ? lastType.order + 1 : 1;

    // Preparar dados do tipo
    const roomTypeData = {
      id,
      nome: nome.trim(),
      periodosConfig: periodosConfig || new Map(),
      precosBase: precosBase || {
        '4h': 50.00,
        '6h': 70.00,
        '12h': 100.00,
        'daily': 150.00
      },
      amenidadesPadrao: amenidadesPadrao || ['wifi', 'ar_condicionado', 'tv'],
      descricao: descricao || `Quarto tipo ${nome}`,
      order: newOrder,
      createdBy: req.user?.id
    };

    const roomType = new RoomType(roomTypeData);
    await roomType.save();

    console.log('âœ… Tipo criado com sucesso:', roomType.id);

    res.status(201).json({
      success: true,
      data: roomType,
      message: `Tipo "${nome}" criado com sucesso`
    });

  } catch (error) {
    console.error('âŒ Erro ao criar tipo:', error);
    
    if (error.code === 11000) {
      res.status(400).json({
        success: false,
        message: 'Tipo com este ID jÃ¡ existe'
      });
    } else if (error.name === 'ValidationError') {
      const errors = Object.values(error.errors).map(err => err.message);
      res.status(400).json({
        success: false,
        message: 'Dados invÃ¡lidos',
        errors: errors
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'Erro ao criar tipo',
        error: error.message
      });
    }
  }
});

// âœ… PUT /api/room-types/:id - Atualizar tipo
router.put('/:id', authenticate, async (req, res) => {
  try {
    console.log(`ğŸ“¤ PUT /api/room-types/${req.params.id}`);
    console.log('ğŸ“¦ Dados para atualizar:', req.body);
    
    const { nome, periodosConfig, precosBase, amenidadesPadrao, descricao, active, order } = req.body;

    const roomType = await RoomType.findOne({ id: req.params.id });
    if (!roomType) {
      return res.status(404).json({
        success: false,
        message: 'Tipo de quarto nÃ£o encontrado'
      });
    }

    // Atualizar campos
    if (nome && nome.trim()) {
      roomType.nome = nome.trim();
    }
    if (periodosConfig !== undefined) {
      roomType.periodosConfig = new Map(Object.entries(periodosConfig));
    }
    if (precosBase) {
      roomType.precosBase = { ...roomType.precosBase, ...precosBase };
    }
    if (amenidadesPadrao) {
      roomType.amenidadesPadrao = amenidadesPadrao;
    }
    if (descricao !== undefined) {
      roomType.descricao = descricao;
    }
    if (typeof active === 'boolean') {
      roomType.active = active;
    }
    if (typeof order === 'number') {
      roomType.order = order;
    }
    
    roomType.updatedBy = req.user?.id;

    await roomType.save();

    console.log('âœ… Tipo atualizado:', roomType.id);

    res.json({
      success: true,
      data: roomType,
      message: `Tipo "${roomType.nome}" atualizado com sucesso`
    });

  } catch (error) {
    console.error('âŒ Erro ao atualizar tipo:', error);
    
    if (error.name === 'ValidationError') {
      const errors = Object.values(error.errors).map(err => err.message);
      res.status(400).json({
        success: false,
        message: 'Dados invÃ¡lidos',
        errors: errors
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'Erro ao atualizar tipo',
        error: error.message
      });
    }
  }
});

// âœ… DELETE /api/room-types/:id - Deletar tipo (soft delete)
router.delete('/:id', authenticate, async (req, res) => {
  try {
    console.log(`ğŸ—‘ï¸ DELETE /api/room-types/${req.params.id}`);
    
    // Verificar se nÃ£o Ã© um tipo padrÃ£o
    const protectedTypes = ['standard', 'premium', 'luxo', 'suite'];
    if (protectedTypes.includes(req.params.id)) {
      return res.status(400).json({
        success: false,
        message: 'NÃ£o Ã© possÃ­vel deletar tipos padrÃ£o'
      });
    }

    const roomType = await RoomType.findOne({ id: req.params.id });
    if (!roomType) {
      return res.status(404).json({
        success: false,
        message: 'Tipo de quarto nÃ£o encontrado'
      });
    }

    // Verificar se hÃ¡ quartos usando este tipo
    const Room = require('../models/Room');
    const roomsWithType = await Room.countDocuments({ 
      type: req.params.id, 
      isActive: true 
    });
    
    if (roomsWithType > 0) {
      return res.status(400).json({
        success: false,
        message: `NÃ£o Ã© possÃ­vel deletar. Existem ${roomsWithType} quartos usando este tipo.`,
        data: { roomsCount: roomsWithType }
      });
    }

    // Soft delete
    roomType.active = false;
    roomType.updatedBy = req.user?.id;
    await roomType.save();

    console.log('âœ… Tipo deletado (soft):', roomType.nome);

    res.json({
      success: true,
      message: `Tipo "${roomType.nome}" removido com sucesso`
    });

  } catch (error) {
    console.error('âŒ Erro ao deletar tipo:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao deletar tipo',
      error: error.message
    });
  }
});

// âœ… PATCH /api/room-types/:id/order - Atualizar ordem
router.patch('/:id/order', authenticate, async (req, res) => {
  try {
    console.log(`ğŸ”„ PATCH /api/room-types/${req.params.id}/order`);
    
    const { order } = req.body;
    
    if (typeof order !== 'number' || order < 0) {
      return res.status(400).json({
        success: false,
        message: 'Ordem deve ser um nÃºmero nÃ£o negativo'
      });
    }

    const roomType = await RoomType.findOne({ id: req.params.id });
    if (!roomType) {
      return res.status(404).json({
        success: false,
        message: 'Tipo nÃ£o encontrado'
      });
    }

    roomType.order = order;
    roomType.updatedBy = req.user?.id;
    await roomType.save();

    res.json({
      success: true,
      data: roomType,
      message: 'Ordem atualizada com sucesso'
    });

  } catch (error) {
    console.error('âŒ Erro ao atualizar ordem:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao atualizar ordem',
      error: error.message
    });
  }
});

// âœ… POST /api/room-types/init - Inicializar tipos padrÃ£o
router.post('/init', authenticate, async (req, res) => {
  try {
    console.log('ğŸ—ï¸ POST /api/room-types/init - Inicializando tipos padrÃ£o...');
    
    // Verificar se usuÃ¡rio Ã© admin
    if (req.user?.role !== 'admin') {
      return res.status(403).json({
        success: false,
        message: 'Apenas administradores podem inicializar tipos padrÃ£o'
      });
    }

    await RoomType.criarTiposPadrao();

    const tipos = await RoomType.findActive();

    res.json({
      success: true,
      data: tipos,
      message: 'Tipos padrÃ£o inicializados com sucesso'
    });

  } catch (error) {
    console.error('âŒ Erro ao inicializar tipos:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao inicializar tipos',
      error: error.message
    });
  }
});

module.exports = router;
