// routes/roomTypes.js - VERSÃO COM AUTENTICAÇÃO REATIVADA
const express = require('express');
const router = express.Router();
const RoomType = require('../models/RoomType');
const { authenticate } = require('../middleware/auth'); // ✅ REATIVADO

// ✅ GET /api/room-types - Listar todos os tipos (COM AUTH)
router.get('/', authenticate, async (req, res) => {
  try {
    console.log('📥 GET /api/room-types - Listando tipos de quarto...');
    
    // ✅ CORRIGIDO: Usar findAtivos em vez de findActive
    const roomTypes = await RoomType.findAtivos();
    
    console.log(`✅ ${roomTypes.length} tipos encontrados`);
    
    res.json({
      success: true,
      data: roomTypes,
      message: `${roomTypes.length} tipos de quarto encontrados`
    });
  } catch (error) {
    console.error('❌ Erro ao buscar tipos de quarto:', error);
    res.status(500).json({
      success: false,
      message: 'Erro interno do servidor',
      error: error.message
    });
  }
});

// ✅ GET /api/room-types/:id - Buscar tipo específico (COM AUTH)
router.get('/:id', authenticate, async (req, res) => {
  try {
    console.log(`📥 GET /api/room-types/${req.params.id}`);
    
    // ✅ CORRIGIDO: Usar disponibilidade.ativo em vez de active
    const roomType = await RoomType.findOne({ 
      id: req.params.id, 
      'disponibilidade.ativo': true 
    });
    
    if (!roomType) {
      return res.status(404).json({
        success: false,
        message: 'Tipo de quarto não encontrado'
      });
    }
    
    res.json({
      success: true,
      data: roomType,
      message: 'Tipo encontrado'
    });
  } catch (error) {
    console.error('❌ Erro ao buscar tipo:', error);
    res.status(500).json({
      success: false,
      message: 'Erro interno do servidor',
      error: error.message
    });
  }
});

// ✅ POST /api/room-types - Criar novo tipo (COM AUTH)
router.post('/', authenticate, async (req, res) => {
  try {
    console.log('📤 POST /api/room-types - Criando novo tipo...');
    console.log('📦 Dados recebidos:', req.body);
    
    const { nome, precosPorPeriodo, amenidades, descricao, configuracao } = req.body;

    if (!nome || !nome.trim()) {
      return res.status(400).json({
        success: false,
        message: 'Nome do tipo é obrigatório'
      });
    }

    const id = nome.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

    // Verificar se já existe
    const existingType = await RoomType.findOne({ id });
    if (existingType) {
      return res.status(400).json({
        success: false,
        message: 'Tipo de quarto já existe'
      });
    }

    // Buscar a maior ordem atual
    const lastType = await RoomType.findOne().sort({ ordem: -1 });
    const newOrder = lastType ? lastType.ordem + 1 : 1;

    // ✅ DADOS ATUALIZADOS PARA O NOVO MODELO
    const roomTypeData = {
      id,
      nome: nome.trim(),
      precosPorPeriodo: precosPorPeriodo || {},
      amenidades: amenidades || ['wifi', 'ar_condicionado', 'tv'],
      descricao: descricao || `Quarto tipo ${nome}`,
      configuracao: configuracao || { capacidadeMaxima: 2 },
      ordem: newOrder,
      criadoPor: req.user?.id || req.user?._id
    };

    const roomType = new RoomType(roomTypeData);
    await roomType.save();

    console.log('✅ Tipo criado com sucesso:', roomType.id);

    res.status(201).json({
      success: true,
      data: roomType,
      message: `Tipo "${nome}" criado com sucesso`
    });

  } catch (error) {
    console.error('❌ Erro ao criar tipo:', error);
    
    if (error.code === 11000) {
      res.status(400).json({
        success: false,
        message: 'Tipo com este ID já existe'
      });
    } else if (error.name === 'ValidationError') {
      const errors = Object.values(error.errors).map(err => err.message);
      res.status(400).json({
        success: false,
        message: 'Dados inválidos',
        errors: errors
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'Erro ao criar tipo',
        error: error.message
      });
    }
  }
});

// ✅ PUT /api/room-types/:id - Atualizar tipo (VERSÃO CORRIGIDA)
router.put('/:id', authenticate, async (req, res) => {
  try {
    console.log(`📤 PUT /api/room-types/${req.params.id}`);
    console.log('📦 Dados recebidos:', JSON.stringify(req.body, null, 2));
    
    const { nome, precosPorPeriodo, amenidades, descricao, configuracao, disponibilidade, ativo, active } = req.body;

    // ✅ BUSCAR TIPO EXISTENTE
    const roomType = await RoomType.findOne({ id: req.params.id });
    if (!roomType) {
      console.log(`❌ Tipo não encontrado: ${req.params.id}`);
      return res.status(404).json({
        success: false,
        message: 'Tipo de quarto não encontrado'
      });
    }

    console.log('📋 Tipo encontrado:', roomType.nome);

    // ✅ ATUALIZAR CAMPOS COM VALIDAÇÃO
    if (nome && nome.trim()) {
      roomType.nome = nome.trim();
      console.log('✅ Nome atualizado:', roomType.nome);
    }

    // ✅ ATUALIZAR PREÇOS POR PERÍODO (PRINCIPAL)
    if (precosPorPeriodo && typeof precosPorPeriodo === 'object') {
      // Verificar se há preços válidos
      const precosValidos = Object.entries(precosPorPeriodo).filter(([_, preco]) => 
        typeof preco === 'number' && preco > 0
      );
      
      if (precosValidos.length > 0) {
        roomType.precosPorPeriodo = { ...precosPorPeriodo };
        console.log('✅ Preços atualizados:', roomType.precosPorPeriodo);
        console.log(`📊 ${precosValidos.length} preços válidos recebidos`);
      } else {
        console.log('⚠️ Nenhum preço válido encontrado nos dados recebidos');
        return res.status(400).json({
          success: false,
          message: 'É necessário pelo menos um preço válido (maior que zero)'
        });
      }
    } else {
      console.log('⚠️ Campo precosPorPeriodo não fornecido ou inválido');
    }

    // ✅ ATUALIZAR OUTROS CAMPOS
    if (amenidades && Array.isArray(amenidades)) {
      roomType.amenidades = amenidades;
      console.log('✅ Amenidades atualizadas:', roomType.amenidades);
    }

    if (descricao !== undefined) {
      roomType.descricao = descricao;
      console.log('✅ Descrição atualizada');
    }

    if (configuracao && typeof configuracao === 'object') {
      roomType.configuracao = { ...roomType.configuracao, ...configuracao };
      console.log('✅ Configuração atualizada:', roomType.configuracao);
    }

    if (disponibilidade && typeof disponibilidade === 'object') {
      roomType.disponibilidade = { ...roomType.disponibilidade, ...disponibilidade };
      console.log('✅ Disponibilidade atualizada:', roomType.disponibilidade);
    }

    // ✅ CAMPOS DE ATIVAÇÃO
    if (ativo !== undefined) {
      roomType.ativo = ativo;
      roomType.active = ativo;
      if (!roomType.disponibilidade) roomType.disponibilidade = {};
      roomType.disponibilidade.ativo = ativo;
      console.log('✅ Status ativo atualizado:', ativo);
    }

    if (active !== undefined) {
      roomType.active = active;
      roomType.ativo = active;
      if (!roomType.disponibilidade) roomType.disponibilidade = {};
      roomType.disponibilidade.ativo = active;
      console.log('✅ Status active atualizado:', active);
    }
    
    // ✅ AUDITORIA
    roomType.atualizadoPor = req.user?.id || req.user?._id;

    // ✅ SALVAR NO BANCO
    console.log('💾 Salvando no banco de dados...');
    await roomType.save();

    console.log('✅ Tipo salvo com sucesso no banco');
    console.log('📊 Preços finais salvos:', roomType.precosPorPeriodo);

    // ✅ RESPOSTA DE SUCESSO
    res.json({
      success: true,
      data: roomType,
      message: `Tipo "${roomType.nome}" atualizado com sucesso`
    });

  } catch (error) {
    console.error('❌ Erro ao atualizar tipo:', error);
    
    if (error.name === 'ValidationError') {
      const errors = Object.values(error.errors).map(err => err.message);
      console.error('❌ Erros de validação:', errors);
      res.status(400).json({
        success: false,
        message: 'Dados inválidos',
        errors: errors
      });
    } else if (error.name === 'CastError') {
      console.error('❌ Erro de tipo de dados:', error.message);
      res.status(400).json({
        success: false,
        message: 'Formato de dados inválido'
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'Erro interno do servidor ao atualizar tipo',
        error: error.message
      });
    }
  }
});
// ✅ DELETE /api/room-types/:id - Deletar tipo (COM AUTH)
router.delete('/:id', authenticate, async (req, res) => {
  try {
    console.log(`🗑️ DELETE /api/room-types/${req.params.id}`);
    
    // Verificar se não é um tipo padrão
    const protectedTypes = ['standard', 'premium', 'luxo', 'suite'];
    if (protectedTypes.includes(req.params.id)) {
      return res.status(400).json({
        success: false,
        message: 'Não é possível deletar tipos padrão'
      });
    }

    const roomType = await RoomType.findOne({ id: req.params.id });
    if (!roomType) {
      return res.status(404).json({
        success: false,
        message: 'Tipo de quarto não encontrado'
      });
    }

    // Verificar se há quartos usando este tipo
    const Room = require('../models/Room');
    const roomsWithType = await Room.countDocuments({ 
      type: req.params.id, 
      isActive: true 
    });
    
    if (roomsWithType > 0) {
      return res.status(400).json({
        success: false,
        message: `Não é possível deletar. Existem ${roomsWithType} quartos usando este tipo.`,
        data: { roomsCount: roomsWithType }
      });
    }

    // Soft delete
    roomType.disponibilidade.ativo = false;
    roomType.atualizadoPor = req.user?.id || req.user?._id;
    await roomType.save();

    console.log('✅ Tipo deletado (soft):', roomType.nome);

    res.json({
      success: true,
      message: `Tipo "${roomType.nome}" removido com sucesso`
    });

  } catch (error) {
    console.error('❌ Erro ao deletar tipo:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao deletar tipo',
      error: error.message
    });
  }
});

// ✅ POST /api/room-types/init - Inicializar tipos padrão (COM AUTH)
router.post('/init', authenticate, async (req, res) => {
  try {
    console.log('🏗️ POST /api/room-types/init - Inicializando tipos padrão...');
    
    // Verificar se usuário é admin
    if (req.user?.role !== 'admin') {
      return res.status(403).json({
        success: false,
        message: 'Apenas administradores podem inicializar tipos padrão'
      });
    }

    const tiposCriados = await RoomType.criarTiposPadrao();

    res.json({
      success: true,
      data: tiposCriados,
      message: 'Tipos padrão inicializados com sucesso'
    });

  } catch (error) {
    console.error('❌ Erro ao inicializar tipos:', error);
    res.status(500).json({
      success: false,
      message: 'Erro ao inicializar tipos',
      error: error.message
    });
  }
});

module.exports = router;
